<div class="container p-4">
	<h2 class="text-center mb-3">ğŸš² Registro de Bicicletas</h2>
	<p class="text-center fw-bold"
		 [ngClass]="{
			 'text-success': mensaje.startsWith('âœ…'),
			 'text-danger': mensaje.startsWith('âŒ'),
			 'text-warning': mensaje.startsWith('âš ï¸')
		 }">
		{{ mensaje }}
	</p>

	<!-- Paso 1: Buscar estudiante -->
	<div *ngIf="pasoActual === 'buscar'">
		<form [formGroup]="rutForm" (ngSubmit)="buscarEstudiante()" class="card p-3 shadow-sm">
			<label class="fw-bold mb-1">Ingrese RUT del estudiante:</label>
			<input type="text" formControlName="rut" placeholder="12345678-9" class="form-control mb-3" (input)="sanitizeRutInputRutForm()" (blur)="formatRutIfNeededRutForm()" maxlength="10" />
			<button type="submit" class="btn btn-primary w-100">Buscar estudiante</button>
		</form>
	</div>

	<!-- Paso 2: Registrar estudiante si no existe -->
	<div *ngIf="pasoActual === 'registrarEstudiante'" class="mt-3">
		<h4>ğŸ§ Registrar nuevo estudiante</h4>
		<form [formGroup]="estudianteForm" (ngSubmit)="registrarEstudiante()" class="card p-3 shadow-sm">
			<input class="form-control mb-2" placeholder="Nombre" formControlName="nombre" />
			<input class="form-control mb-2" placeholder="Apellido" formControlName="apellido" />
			<input class="form-control mb-2" placeholder="RUT" formControlName="rut" (input)="sanitizeRutInputEstudiante()" (blur)="formatRutIfNeededEstudiante()" maxlength="10" />
			<input class="form-control mb-2" placeholder="Correo" formControlName="correo" />
			<div class="d-flex gap-2">
				<button type="submit" class="btn btn-success flex-fill">Registrar estudiante</button>
				<button type="button" class="btn btn-secondary flex-fill" (click)="reiniciarFlujo()">Cancelar</button>
			</div>
		</form>
	</div>

	<!-- Paso 3: Opciones si el estudiante ya tiene bicicletas -->
	<div *ngIf="pasoActual === 'opciones'" class="mt-3">
		<h4>âš™ï¸ Opciones de registro</h4>
		<p>El estudiante ya tiene las siguientes bicicletas registradas:</p>

		<ul class="list-group mb-3 shadow-sm">
			<li *ngFor="let bici of bicicletasDelEstudiante"
					class="list-group-item list-group-item-action d-flex justify-content-between align-items-center bici-item"
					[class.selected]="bicicletaSeleccionada && bicicletaSeleccionada._id === bici._id"
					(click)="seleccionarBicicleta(bici)">
				<div>
					<strong>{{ bici.marca }}</strong> - {{ bici.color }}
					<span class="text-muted">({{ bici.estacionamiento }})</span>
				</div>
				<i class="bi bi-pencil-square text-primary"></i>
			</li>
		</ul>

		<div class="d-grid gap-2">
			<button class="btn btn-outline-primary" (click)="registrarNuevaBicicleta()">
				â• Registrar nueva bicicleta
			</button>
			<button class="btn btn-secondary" (click)="reiniciarFlujo()">ğŸ”™ Volver a buscar otro estudiante</button>
		</div>
	</div>

	<!-- Paso 4: Registrar bicicleta (nueva o cambiar estacionamiento) -->
	<div *ngIf="pasoActual === 'registrarBicicleta'" class="mt-3">
		<h4 *ngIf="!bicicletaSeleccionada">ğŸš² Registrar nueva bicicleta</h4>
		<h4 *ngIf="bicicletaSeleccionada">ğŸ”„ Cambiar estacionamiento</h4>

		<form [formGroup]="bicicletaForm" (ngSubmit)="registrarBicicleta()" class="card p-3 shadow-sm">
			<input class="form-control mb-2" placeholder="Marca" formControlName="marca" [readonly]="!!bicicletaSeleccionada" />
			<input class="form-control mb-2" placeholder="Modelo" formControlName="modelo" [readonly]="!!bicicletaSeleccionada" />
			<input class="form-control mb-2" placeholder="Color" formControlName="color" [readonly]="!!bicicletaSeleccionada" />
			<input class="form-control mb-2" placeholder="Identificador" formControlName="identificador" [readonly]="true" />
			<div class="d-flex gap-2 align-items-center">
				<input class="form-control mb-3" placeholder="Estacionamiento" formControlName="estacionamiento" />
				<span *ngIf="qrEstacionamiento" class="badge bg-secondary ms-2">Bloqueado por QR</span>
			</div>

			<div class="d-flex gap-2">
				<button type="submit" class="btn btn-success flex-fill">
					{{ bicicletaSeleccionada ? 'Actualizar estacionamiento' : 'Registrar Bici' }}
				</button>
				<button type="button" class="btn btn-secondary flex-fill" (click)="reiniciarFlujo()">Cancelar</button>
			</div>
		</form>
	</div>
</div>
